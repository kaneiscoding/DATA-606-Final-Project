---
title: "Classification of Spotify Data"
subtitle: "DATA 606 - W2023 Final Project"
author: "Kane Smith, Rodrigo Rosales Alvarez, Arhur Trim, Jordan Keelan, Scott Bennett"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    extra_dependencies:
    - bbm
    - xcolor
---

\newpage
\tableofcontents
\pagebreak

```{r setup, include=FALSE}
# Set R Chunk options
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=6, fig.height=4)

# Set the number of significant digits
options(scipen=50, digits=4)

library(dplyr)
library(ggplot2)
library(tree)
library(MASS)
library(ISLR)
library(car)
library(sampling)
library(caret)
library(AppliedPredictiveModeling)
library(gridExtra)
```


# 1 Introduction

## 1.1 Background

## 1.2 Objective & Topic Importance

# 2 Methodology

## 2.1 Software Used

## 2.2 Data Source

## 2.3 Summary of Variables

```{r}
artists_df <- data.frame(read.csv("../spotify_dataset/artists.csv"))
tracks_df <- data.frame(read.csv("../spotify_dataset/tracks.csv"))
```


## 2.4 Data Cleaning
```{r}
head(artists_df)
head(tracks_df)

tracks_pop <- ggplot(data=tracks_df, aes(x=popularity), title="Full Tracks Dataset Popularity Histogram") + geom_histogram()
artists_pop <- ggplot(data=artists_df, aes(x=popularity), title="Full Artists Dataset Popularity Histogram") + geom_histogram()

tracks_pop
artists_pop
```

```{r}
# Filter out tracks with popularity less than 1
popular_df <- tracks_df %>% filter(popularity > 1)

# normalize Data
popular_labels <- popular_df[, c("id", "name", "artists", "id_artists", "release_date")]
popular_factors <- popular_df[, c("explicit", "key", "mode", "time_signature")]
popular_numeric <- popular_df[, c("duration_ms","popularity", "danceability", "energy", "loudness", "speechiness", "acousticness", "instrumentalness", "liveness", "valence", "tempo")]
popular_scaled <- scale(popular_numeric)
popular_factors <- lapply(popular_factors,factor)
popular_df2 <- data.frame(popular_labels, popular_factors, popular_scaled)
```

```{r}
# Visualize filtered tracks popularity histogram 
tracks_pop_filtered <- ggplot(data=popular_df, aes(x=popularity), title="Full Tracks Dataset Popularity Histogram") + geom_histogram()
#artists_pop_filtered <- ggplot(data=artists_df, aes(x=popularity), title="Full Artists Dataset Popularity Histogram") + geom_histogram()
tracks_pop_scaled <- ggplot(data=popular_df2, aes(x=popularity), title="Full Tracks Dataset Popularity Histogram") + geom_histogram()

tracks_pop_filtered
tracks_pop_scaled
#artists_pop_filtered
```

## 2.5 Data Exploration

### Correlation Matrix

```{r}
#Preliminary Analysis
library(readr)
artists_df <- read.csv("~/Data606/Project/artists.csv")
tracks_df <- read.csv("~/Data606/Project/tracks.csv")
```
```{r}

```
 
```{r}
head(tracks_df)
dim(tracks_df)
```
 
```{r}
tracks_df$year <- eval(substr(tracks_df$release_date, 1,4))
```
 
```{r}
test_str <- "1922-02-22"
test_substr <- substr(test_str, 1,4)
test_substr
```
```{r}
tracks_df$decade <- eval(substr(tracks_df$release_date, 1,3))
```


```{r}
head(tracks_df)
```

```{r}
library(ggplot2)
ggplot(data = tracks_df, mapping = aes(x = year)) + geom_bar()

ggplot(tracks_df, aes(x = factor(year), y = popularity)) + 
  geom_bar(stat = "summary", fun = "mean")

ggplot(tracks_df, aes(x = factor(decade), y = popularity)) + 
  geom_bar(stat = "summary", fun = "mean")
#+ guide_axis()
```

```{r}
ggplot(tracks_df, aes(x = factor(decade), y = loudness)) + 
  geom_bar(stat = "summary", fun = "mean")

ggplot(tracks_df, aes(x = factor(decade), y = energy)) + 
  geom_bar(stat = "summary", fun = "mean")
```

```{r}
tracks_190 <- filter(tracks_df, filter = tracks_df$decade == "190")
```

```{r}
dim(tracks_190)
```

```{r}
tracks_df[478628,]
```

```{r}
tracks_clean <- tracks_df[-478628,]
```

```{r}
plt2 <- ggplot(tracks_clean, aes(x = factor(decade), y = acousticness)) + 
  geom_bar(stat = "summary", fun = "mean") 

plt3 <- ggplot(tracks_clean, aes(x = factor(decade), y = energy)) + 
  geom_bar(stat = "summary", fun = "mean")

plt1 <- ggplot(tracks_clean, aes(x = factor(decade), y = popularity)) + 
  geom_bar(stat = "summary", fun = "mean")

plt4 <- ggplot(tracks_clean, aes(x = factor(decade), y = duration_ms)) + 
  geom_bar(stat = "summary", fun = "mean")
```

```{r}
library(gridExtra)
grid.arrange(plt1, plt2, plt3, plt4, top = "Variation by Decade", ncol = 2)
```


```{r}
#install.packages("ggcorrplot")
library(ggcorrplot)

# Calculate the correlation matrix
cor_matrix <- cor(popular_numeric)

# plot the correlation
ggcorrplot(cor_matrix,
           hc.order = TRUE,
           type = "lower",
           lab = TRUE,
           show.legend = FALSE
           )
```


# 3 Genre Classification

```{r}
popular_df2 <- popular_df2 %>% mutate(popularity_coded = ifelse(popularity >= quantile(popular_df2$popularity, c(.75))[1], 1, 0))

# Convert the outcome variable to a factor
popular_df2$popularity_coded <- as.factor(popular_df2$popularity_coded)

# control object for k-fold cross validation
ctrl <- trainControl(method = "cv", number = 10)
```

## 3.1 LDA
```{r}
#fit a regression model and use k-fold CV to evaluate performance
lda_model <- train(popularity_coded~duration_ms+explicit+ danceability+energy+key+loudness+mode+speechiness+acousticness+instrumentalness+liveness+valence+tempo+time_signature, data=popular_df2, method = "lda", trControl = ctrl)

print(lda_model)
```


### 3.1.1 Assumptions

```{r}
## VIF
model_fit<-lm(popularity~duration_ms+factor(explicit)+ danceability+energy+factor(key)+loudness+factor(mode)+speechiness+acousticness+instrumentalness+liveness+valence+tempo+factor(time_signature), data=popular_df2)

vif(model_fit)

# Influential Outliers 
popular_df[cooks.distance(model_fit)>1,]

# Constant Variance
ncvTest(model_fit)
```

## 4.1 Logistic Regression

```{r}
#fit a regression model and use k-fold CV to evaluate performance
lr_model <- train(popularity_coded ~ duration_ms+explicit+danceability+energy+key+loudness+mode+speechiness+acousticness+instrumentalness+liveness+valence+tempo+time_signature, data = popular_df2, method = "glm", trControl = ctrl, family="binomial")

summary(lr_model)
```

## 4.2 Classification Tree
```{r}
tree_model_class <- train(popularity_coded ~ duration_ms+explicit+danceability+energy+key+loudness+mode+speechiness+acousticness+instrumentalness+liveness+valence+tempo+time_signature, data = popular_df2, trControl = ctrl, method = "rpart")

print(tree_model_class)
```

# Getting the Popularity index from a song

## 3.2 Regression Tree
```{r}
tree_model_reg <- train(popularity ~ duration_ms+explicit+danceability+energy+key+loudness+mode+speechiness+acousticness+instrumentalness+liveness+valence+tempo+time_signature, data = popular_df2, trControl = ctrl, method = "rpart")
print(tree_model_reg)
```

### 3.2.1 Assumptions

## 3.4 Summary of Findings


## 4.3 Summary of Findings

# 5 Conclusion

# 6 References

















